// src/services/api/openai.js - createCompletionãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ç‰ˆ

import { API_CONFIG, ENV, ENDPOINTS } from '../../config/api.js';

class OpenAIService {
  constructor() {
    this.apiKey = ENV.openaiApiKey;
    this.baseURL = API_CONFIG.openai.baseURL;
    this.model = API_CONFIG.openai.model;
  }

  // ğŸ†• ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆç”¨ã®createCompletionãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
  async createCompletion(options) {
    if (!this.apiKey) {
      throw new Error('OpenAI API key not configured');
    }

    try {
      const response = await fetch(`${this.baseURL}${ENDPOINTS.chatgpt.completion}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.apiKey}`
        },
        body: JSON.stringify({
          model: options.model || this.model,
          messages: options.messages,
          max_tokens: options.max_tokens || 300,
          temperature: options.temperature || 0.3
        })
      });

      if (!response.ok) {
        throw new Error(`OpenAI API Error: ${response.status}`);
      }

      const data = await response.json();
      return data;

    } catch (error) {
      console.error('ğŸš¨ OpenAI APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }

  getCurrentYear() {
    return new Date().getFullYear();
  }

  // åˆ†é‡è‡ªå‹•åˆ¤åˆ¥
  async detectCategory(keyword) {
    if (!this.apiKey) {
      return this.detectCategoryOffline(keyword);
    }

    try {
      const response = await fetch(`${this.baseURL}${ENDPOINTS.chatgpt.completion}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: [{
            role: 'user',
            content: `"${keyword}" ã¯ä»¥ä¸‹ã®ã©ã®åˆ†é‡ã§ã™ã‹ï¼Ÿ1ã¤ã ã‘é¸ã‚“ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š

1. product - å•†å“ãŠã™ã™ã‚ãƒ»æ¯”è¼ƒãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°
2. health - ç­‹ãƒˆãƒ¬ãƒ»ãƒ€ã‚¤ã‚¨ãƒƒãƒˆãƒ»å¥åº·ãƒ»ç¾å®¹ãƒ»é‹å‹•
3. money - å‰¯æ¥­ãƒ»æŠ•è³‡ãƒ»ç¯€ç´„ãƒ»è»¢è·ãƒ»ãŠé‡‘ãƒ»ãƒ“ã‚¸ãƒã‚¹
4. lifestyle - å­è‚²ã¦ãƒ»æ–™ç†ãƒ»æƒé™¤ãƒ»ç”Ÿæ´»ãƒ»è¶£å‘³
5. skill - å‹‰å¼·ãƒ»ã‚¹ã‚­ãƒ«ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»å­¦ç¿’ãƒ»è³‡æ ¼

å›ç­”ä¾‹: product`
          }],
          max_tokens: 10,
          temperature: 0
        })
      });

      const data = await response.json();
      const content = (data.choices?.[0]?.message?.content || '').toLowerCase();
      const validCategories = ['product', 'health', 'money', 'lifestyle', 'skill'];

      // å¿œç­”æ–‡ä¸­ã«å«ã¾ã‚Œã‚‹æœ‰åŠ¹ã‚«ãƒ†ã‚´ãƒªã‚’æŠ½å‡ºï¼ˆèª¬æ˜æ–‡ã‚„ç•ªå·ä»˜ãå›ç­”ã«ã‚‚å¯¾å¿œï¼‰
      for (const cat of validCategories) {
        if (content.includes(cat)) {
          console.log(`ğŸ¯ AIåˆ†é‡åˆ¤å®š: "${keyword}" â†’ ${cat}`);
          return cat;
        }
      }

      console.warn(`âš ï¸ ç„¡åŠ¹ãªåˆ†é‡åˆ¤å®š: ${content.slice(0, 30)}..., ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨`);
      return 'product';

    } catch (error) {
      console.error('âŒ åˆ†é‡åˆ¤å®šã‚¨ãƒ©ãƒ¼:', error);
      return this.detectCategoryOffline(keyword);
    }
  }

  // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åˆ†é‡åˆ¤å®š
  detectCategoryOffline(keyword) {
    const lower = keyword.toLowerCase();
    
    if (lower.includes('ãŠã™ã™ã‚') || lower.includes('æ¯”è¼ƒ') || lower.includes('ãƒ¬ãƒ“ãƒ¥ãƒ¼') || 
        lower.includes('ãƒ©ãƒ³ã‚­ãƒ³ã‚°') || lower.includes('vs')) {
      return 'product';
    }
    if (lower.includes('ç­‹ãƒˆãƒ¬') || lower.includes('ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ') || lower.includes('å¥åº·') || 
        lower.includes('ç¾å®¹') || lower.includes('é‹å‹•')) {
      return 'health';
    }
    if (lower.includes('å‰¯æ¥­') || lower.includes('æŠ•è³‡') || lower.includes('ç¯€ç´„') || 
        lower.includes('è»¢è·') || lower.includes('ãŠé‡‘')) {
      return 'money';
    }
    if (lower.includes('å­è‚²ã¦') || lower.includes('æ–™ç†') || lower.includes('æƒé™¤') || 
        lower.includes('ç”Ÿæ´»') || lower.includes('è¶£å‘³')) {
      return 'lifestyle';
    }
    if (lower.includes('å‹‰å¼·') || lower.includes('å­¦ç¿’') || lower.includes('ã‚¹ã‚­ãƒ«') || 
        lower.includes('ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°') || lower.includes('è³‡æ ¼')) {
      return 'skill';
    }
    
    return 'product';
  }

  // å®Ÿç”¨çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆæ¶ç©ºã®è©±ã‚’æ’é™¤ï¼‰
  getCategoryPrompt(keyword, category, format, duration) {
    const formatSpecs = {
      short: { width: 1080, height: 1920 },
      medium: { width: 1920, height: 1080 }
    };
    const spec = formatSpecs[format] || formatSpecs.medium;

    const prompts = {
      // å…¨ã‚¸ãƒ£ãƒ³ãƒ«å…±é€šã§æ·±æ˜ã‚Šã‚’ä¿ƒã™è¿½åŠ è¦ä»¶
      generic_deep: `ä»¥ä¸‹ã®è¦³ç‚¹ã‚’å¿…ãšå«ã‚ã¦ã€å…·ä½“æ€§ã¨å†ç¾æ€§ã‚’é«˜ã‚ã¦ãã ã•ã„ï¼š
- å†’é ­3ç§’ã®ãƒ•ãƒƒã‚¯ï¼ˆã‚ˆãã‚ã‚‹å¤±æ•—â†’ä¸€è¨€ã®è§£æ±ºç­–ï¼‰
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ˜ç¢ºåŒ–ï¼ˆèª°å‘ã‘/å‰ææ¡ä»¶ï¼‰
- 3ãƒã‚¤ãƒ³ãƒˆã®ãã‚Œãã‚Œã«ï¼šå…·ä½“ä¾‹3ã¤ãƒ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ»é »å‡ºãƒŸã‚¹ã¨å¯¾ç­–ãƒ»ä»Šæ—¥ã‹ã‚‰ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆæœ€çŸ­ã§æˆæœã‚’å‡ºã™ãŸã‚ã«ä»Šæ—¥ã‚„ã‚‹1ã¤ï¼‰
- çŸ­æœŸãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆ7æ—¥ or 30æ—¥ãªã©æ®µéšçš„ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
- ç¥è©±ã¨äº‹å®Ÿï¼ˆèª¤è§£ã‚’æ­£ã™ï¼‰
`,
      product: `ã€Œ${keyword}ã€ã«ã¤ã„ã¦ã€è¦–è´ç¶­æŒç‡ãŒä¸ŠãŒã‚‹æ§‹æˆã§ã€å®Ÿéš›ã«å½¹ç«‹ã¤å…·ä½“çš„ãªæƒ…å ±ã‚’3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚

**é‡è¦ãªæ¡ä»¶:**
- æ¶ç©ºã®äººç‰©ã‚„ä¼šç¤¾ã¯ä½¿ã‚ãªã„
- å…·ä½“çš„ã§å®Ÿç”¨çš„ãªæƒ…å ±ã®ã¿
- åˆå¿ƒè€…ã«ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜
- å®Ÿåœ¨ã™ã‚‹å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ãƒ»æ–¹æ³•ã‚’ç´¹ä»‹
- ã‚¯ãƒªãƒƒã‚¯ã—ãŸããªã‚‹æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ˜ç¢ºã€ãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆã€æ•°å­—/æ‹¬å¼§/å¼·èª¿ï¼‰ã€28ã€œ36æ–‡å­—ç¨‹åº¦`,

      health: `ã€Œ${keyword}ã€ã«ã¤ã„ã¦ã€è¦–è´ç¶­æŒç‡ãŒä¸ŠãŒã‚‹æ§‹æˆã§ã€å®Ÿéš›ã«åŠ¹æœçš„ãªæ–¹æ³•ã‚’3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚

**é‡è¦ãªæ¡ä»¶:**
- ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸæƒ…å ±
- å…·ä½“çš„ãªæ•°å­—ãƒ»æ™‚é–“ãƒ»æ–¹æ³•
- åˆå¿ƒè€…ãŒå®Ÿè·µã—ã‚„ã™ã„å†…å®¹
- å®‰å…¨ã§ç¾å®Ÿçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ã‚¯ãƒªãƒƒã‚¯ã—ãŸããªã‚‹æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ˜ç¢ºã€ãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆã€æ•°å­—/æ‹¬å¼§/å¼·èª¿ï¼‰ã€28ã€œ36æ–‡å­—ç¨‹åº¦`,

      // è¿½åŠ ã®æ·±æ˜ã‚Šè¦ä»¶ï¼ˆhealthç³»ã¯ã‚ˆã‚Šå…·ä½“åŒ–ï¼‰
      health_deep: `ä»¥ä¸‹ã®è¦³ç‚¹ã‚’å¿…ãšå«ã‚ã¦ã€ã‚ˆã‚Šå…·ä½“çš„ã«ï¼š
- å†’é ­3ç§’ã®ãƒ•ãƒƒã‚¯ï¼ˆã‚ã‚ŠãŒã¡ãªå¤±æ•—â†’ä¸€è¨€ã§è§£æ±ºç­–ï¼‰
- é€±ã‚ãŸã‚Šã®é »åº¦ãƒ»ã‚»ãƒƒãƒˆæ•°ãƒ»å›æ•°ãƒ»ä¼‘æ¯ï¼ˆä¾‹: é€±3å›/1éƒ¨ä½ã‚ãŸã‚Š8ã€œ12å›Ã—3ã‚»ãƒƒãƒˆ/60ã€œ90ç§’ãƒ¬ã‚¹ãƒˆï¼‰
- 1é€±é–“ã®ã‚µãƒ³ãƒ—ãƒ«è¨ˆç”»ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»æ›œæ—¥ãƒ»æ‰€è¦æ™‚é–“ï¼‰
- ã‚ˆãã‚ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãƒŸã‚¹3ã¤ã¨ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ
- å™¨å…·ã‚ã‚Š/ãªã—ã®ä»£æ›¿æ¡ˆï¼ˆè‡ªé‡/ã‚´ãƒ ãƒãƒ³ãƒ‰ï¼‰
- ç¥è©±ã¨äº‹å®Ÿï¼ˆé–“é•ã„ã‚„ã™ã„è€ƒãˆã‚’æ­£ã™ï¼‰
- 30æ—¥ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆåˆé€±â†’2é€±ç›®â†’3ã€œ4é€±ç›®ã®ä¼¸ã°ã—æ–¹ï¼‰
- 1æ—¥ã®æ „é¤Šãƒ»ç¡çœ ã®æœ€ä½ãƒ©ã‚¤ãƒ³ï¼ˆã‚¿ãƒ³ãƒ‘ã‚¯è³ª/ä½“é‡, ç¡çœ æ™‚é–“ï¼‰
`,

      money: `ã€Œ${keyword}ã€ã«ã¤ã„ã¦ã€è¦–è´ç¶­æŒç‡ãŒä¸ŠãŒã‚‹æ§‹æˆã§ã€å®Ÿéš›ã«å½¹ç«‹ã¤å…·ä½“çš„ãªæƒ…å ±ã‚’3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚

**é‡è¦ãªæ¡ä»¶:**
- æ¶ç©ºã®æˆåŠŸè«‡ã¯ä½¿ã‚ãªã„
- å…·ä½“çš„ãªé‡‘é¡ãƒ»æ™‚é–“ãƒ»æ–¹æ³•
- åˆå¿ƒè€…ãŒå§‹ã‚ã‚„ã™ã„å†…å®¹
- ç¾å®Ÿçš„ã§å®‰å…¨ãªæ–¹æ³•ã®ã¿
- ã‚¯ãƒªãƒƒã‚¯ã—ãŸããªã‚‹æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ˜ç¢ºã€ãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆã€æ•°å­—/æ‹¬å¼§/å¼·èª¿ï¼‰ã€28ã€œ36æ–‡å­—ç¨‹åº¦`,

      lifestyle: `ã€Œ${keyword}ã€ã«ã¤ã„ã¦ã€è¦–è´ç¶­æŒç‡ãŒä¸ŠãŒã‚‹æ§‹æˆã§ã€å®Ÿéš›ã«å½¹ç«‹ã¤å…·ä½“çš„ãªæ–¹æ³•ã‚’3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚

**é‡è¦ãªæ¡ä»¶:**
- å®Ÿè·µçš„ã§å…·ä½“çš„ãªæ–¹æ³•
- æ™‚çŸ­ãƒ»åŠ¹ç‡åŒ–ã®ã‚³ãƒ„
- åˆå¿ƒè€…ã§ã‚‚ç°¡å˜ã«ã§ãã‚‹
- æ—¥å¸¸ç”Ÿæ´»ã«å–ã‚Šå…¥ã‚Œã‚„ã™ã„
- ã‚¯ãƒªãƒƒã‚¯ã—ãŸããªã‚‹æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ˜ç¢ºã€ãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆã€æ•°å­—/æ‹¬å¼§/å¼·èª¿ï¼‰ã€28ã€œ36æ–‡å­—ç¨‹åº¦`,

      skill: `ã€Œ${keyword}ã€ã«ã¤ã„ã¦ã€è¦–è´ç¶­æŒç‡ãŒä¸ŠãŒã‚‹æ§‹æˆã§ã€åŠ¹ç‡çš„ãªå­¦ç¿’æ–¹æ³•ã‚’3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã§è§£èª¬ã—ã¦ãã ã•ã„ã€‚

**é‡è¦ãªæ¡ä»¶:**
- å…·ä½“çš„ãªå­¦ç¿’æ™‚é–“ãƒ»æ‰‹é †
- åˆå¿ƒè€…å‘ã‘ã®æ®µéšçš„ãªæ–¹æ³•
- å®Ÿéš›ã«ä½¿ãˆã‚‹å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹
- æŒ«æŠ˜ã—ã«ãã„ç¶™ç¶šã®ã‚³ãƒ„
- ã‚¯ãƒªãƒƒã‚¯ã—ãŸããªã‚‹æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ˜ç¢ºã€ãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆã€æ•°å­—/æ‹¬å¼§/å¼·èª¿ï¼‰ã€28ã€œ36æ–‡å­—ç¨‹åº¦`
    };

    let basePrompt = prompts[category] || prompts.product;
    // å…¨ã‚¸ãƒ£ãƒ³ãƒ«ã«å…±é€šã®æ·±æ˜ã‚Šè¦ä»¶ã‚’ä»˜ä¸
    basePrompt = `${basePrompt}\n\n${prompts.generic_deep}`;
    // ã‚«ãƒ†ã‚´ãƒªå€‹åˆ¥ã®æ·±æ˜ã‚ŠãŒã‚ã‚Œã°ã•ã‚‰ã«ä»˜ä¸
    if (category === 'health') {
      basePrompt = `${basePrompt}\n\n${prompts.health_deep}`;
    }

    const jsonTemplate = `{
  "title": "",  
  "videoType": "${category}æƒ…å ±",
  "duration": ${duration},
  "canvas": {
    "width": ${spec.width},
    "height": ${spec.height},
    "backgroundColor": "#ffffff"
  },
  "content": {
    "description": "${keyword}ã«ã¤ã„ã¦å®Ÿç”¨çš„ã§å½¹ç«‹ã¤æƒ…å ±",
    "structure": "åŸºæœ¬çŸ¥è­˜â†’å…·ä½“çš„æ–¹æ³•â†’å®Ÿè·µã®ã‚³ãƒ„"
  },
  "items": [
    {
      "id": 1,
      "name": "å…·ä½“çš„ãªãƒã‚¤ãƒ³ãƒˆ1",
      "content": {
        "main": "ã‚ã‹ã‚Šã‚„ã™ã„èª¬æ˜ï¼ˆå…¨ä½“åƒâ†’çµè«–â†’ç†ç”±ã®é †ã§ç°¡æ½”ã«ï¼‰",
        "details": "æ·±æ˜ã‚Šè§£èª¬ï¼ˆå…·ä½“ä¾‹3ã¤ãƒ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ»é »å‡ºãƒŸã‚¹ã¨å¯¾ç­–ãƒ»ä»Šæ—¥ã‹ã‚‰ã§ãã‚‹1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰"
      }
    },
    {
      "id": 2,
      "name": "å…·ä½“çš„ãªãƒã‚¤ãƒ³ãƒˆ2", 
      "content": {
        "main": "ã‚ã‹ã‚Šã‚„ã™ã„èª¬æ˜",
        "details": "è©³ç´°ãªè§£èª¬ã¨å…·ä½“ä¾‹ï¼ˆæ•°å€¤ãƒ»é »åº¦ãƒ»å ´é¢åˆ¥ï¼‰"
      }
    },
    {
      "id": 3,
      "name": "å…·ä½“çš„ãªãƒã‚¤ãƒ³ãƒˆ3",
      "content": {
        "main": "ã‚ã‹ã‚Šã‚„ã™ã„èª¬æ˜", 
        "details": "è©³ç´°ãªè§£èª¬ã¨å…·ä½“ä¾‹ï¼ˆãƒ¡ãƒªãƒƒãƒˆ/ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãƒ»æ³¨æ„ç‚¹ãƒ»é•·æœŸçš„åŠ¹æœï¼‰"
      }
    }
  ]
}`;

    return `${basePrompt}

ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
${jsonTemplate}

é‡è¦ï¼š
- ã‚¿ã‚¤ãƒˆãƒ«ã¯æ—¥æœ¬èªã§ã€ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚„ã™ã„å¼·ã„è¡¨ç¾ã«ã™ã‚‹ï¼ˆãƒ™ãƒãƒ•ã‚£ãƒƒãƒˆãƒ»æ•°å­—ãƒ»æ‹¬å¼§ï¼‰
- items[0] ã¯ç‰¹ã«æ·±æ˜ã‚Šã—ã€detailsã«å…·ä½“ä¾‹3ã¤ãƒ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’å«ã‚ã‚‹
- å®Ÿç”¨çš„ã§å…·ä½“çš„ãªå†…å®¹ã®ã¿
- æ¶ç©ºã®è©±ã‚„èª‡å¤§ãªè¡¨ç¾ã¯é¿ã‘ã‚‹
- åˆå¿ƒè€…ãŒå®Ÿéš›ã«è¡Œå‹•ã§ãã‚‹æƒ…å ±`;
  }

  // ãƒ¡ã‚¤ãƒ³ç”Ÿæˆé–¢æ•°
  async generateVideoDesign(keyword, template, format = 'short', duration = 30) {
    console.log(`ğŸ¯ å®Ÿç”¨çš„AIç”Ÿæˆé–‹å§‹: ${keyword}`);

    try {
      // åˆ†é‡åˆ¤å®š
      const category = await this.detectCategory(keyword);
      console.log(`ğŸ“‚ åˆ¤å®šã•ã‚ŒãŸåˆ†é‡: ${category}`);

      // APIãªã—ã®å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
      if (!this.apiKey) {
        console.warn('âš ï¸ APIã‚­ãƒ¼æœªè¨­å®šã€å®Ÿç”¨çš„ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨');
        return this.getRealisticMockData(keyword, category, format, duration);
      }

      // APIå‘¼ã³å‡ºã—
      const prompt = this.getCategoryPrompt(keyword, category, format, duration);
      
      const response = await fetch(`${this.baseURL}${ENDPOINTS.chatgpt.completion}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.apiKey}`
        },
        body: JSON.stringify({
          model: this.model,
          messages: [
            {
              role: 'system',
              content: `ã‚ãªãŸã¯${category}åˆ†é‡ã®å°‚é–€å®¶ã§ã™ã€‚å®Ÿç”¨çš„ã§åˆå¿ƒè€…ã«ã‚ã‹ã‚Šã‚„ã™ã„æƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚æ¶ç©ºã®è©±ã¯ä½¿ã‚ãšã€å…·ä½“çš„ã§å®Ÿè·µçš„ãªå†…å®¹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚`
            },
            {
              role: 'user',
              content: prompt
            }
          ],
          max_tokens: 2000,
          temperature: 0.3
        })
      });

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = await response.json();
      const content = data.choices[0].message.content;
      
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      const jsonString = jsonMatch ? jsonMatch[0] : content;
      const result = JSON.parse(jsonString);
      
      result.duration = duration;
      result.category = category;
      
      console.log(`âœ… å®Ÿç”¨çš„AIè¨­è¨ˆå›³å®Œæˆ: ${category} - ${result.title}`);
      return result;

    } catch (error) {
      console.error('âŒ å®Ÿç”¨çš„ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
      const fallbackCategory = this.detectCategoryOffline(keyword);
      return this.getRealisticMockData(keyword, fallbackCategory, format, duration);
    }
  }

  // å®Ÿç”¨çš„ãªãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆ†é‡åˆ¥ï¼‰
  getRealisticMockData(keyword, category, format, duration) {
    const spec = format === 'short' ? { width: 1080, height: 1920 } : { width: 1920, height: 1080 };
    
    const title = this.generateClickableTitle(keyword, category);
    
    // health Ã— ç­‹ãƒˆãƒ¬ åˆå¿ƒè€…å‘ã‘ã®ãƒªãƒƒãƒãƒ¢ãƒƒã‚¯
    if (category === 'health' && /ç­‹ãƒˆãƒ¬|ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°|ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆ|åˆå¿ƒè€…/.test(keyword)) {
      return {
        title: title,
        videoType: `${category}æƒ…å ±`,
        duration: duration,
        canvas: { width: spec.width, height: spec.height, backgroundColor: "#ffffff" },
        content: {
          description: `${keyword}ã‚’30æ—¥ã§ç¿’æ…£åŒ–ã™ã‚‹ãŸã‚ã®æœ€çŸ­ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—`,
          structure: "ãƒ•ãƒƒã‚¯â†’å…¨ä½“åƒâ†’å…·ä½“ãƒ¡ãƒ‹ãƒ¥ãƒ¼â†’ãƒŸã‚¹ä¿®æ­£â†’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—â†’ä»Šæ—¥ã®1æ­©"
        },
        items: [
          {
            id: 1,
            name: "æœ€çŸ­ã§çµæœã‚’å‡ºã™åŸºç¤ï¼ˆã¾ãšã‚³ãƒ¬ã ã‘ï¼‰",
            content: {
              main: "é€±3å›ãƒ»8ã€œ12å›Ã—3ã‚»ãƒƒãƒˆãƒ»ãƒ¬ã‚¹ãƒˆ60ã€œ90ç§’ãŒæœ€çŸ­ã‚³ã‚¹ãƒ‘",
              details: "å…·ä½“ä¾‹3ã¤: ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ/è…•ç«‹ã¦/ãƒ—ãƒ©ãƒ³ã‚¯ï¼ˆå™¨å…·ãªã—ï¼‰ã€‚\n" +
                "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: 24ã€œ48æ™‚é–“ç©ºã‘ã‚‹/æœ€å¾Œ2å›ãŒã‚®ãƒª/ç—›ã¿ã¯ä¸­æ­¢/ãƒ•ã‚©ãƒ¼ãƒ ã‚’é¡ã§ç¢ºèªã€‚\n" +
                "ãƒŸã‚¹ã¨ä¿®æ­£: 1) åå‹•â†’ã‚†ã£ãã‚Šä¸‹ã‚ã™ 2) å¯å‹•åŸŸãŒæµ…ã„â†’è†/è‚˜ãŒä¼¸ã³åˆ‡ã‚‰ãªã„ç¯„å›²ã§æ·±ã 3) å‘¼å¸æ­¢ã‚â†’ä¸Šã’ã§åãã€‚\n" +
                "ä»Šæ—¥ã®1æ­©: ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ10å›Ã—2ã‚»ãƒƒãƒˆï¼ˆå£ã«èƒŒã‚’å‘ã‘ã¦ã—ã‚ƒãŒã‚€ã¨å§¿å‹¢ãŒå®‰å®šï¼‰ã€‚"
            }
          },
          {
            id: 2,
            name: "1é€±é–“ã®ã‚µãƒ³ãƒ—ãƒ«è¨ˆç”»ï¼ˆå™¨å…·ãªã—/ã‚ã‚Šï¼‰",
            content: {
              main: "æœˆ: ä¸‹åŠèº«/æ°´: ä¸ŠåŠèº«/é‡‘: ä½“å¹¹ï¼ˆå„15åˆ†ã§OKï¼‰",
              details: "å™¨å…·ãªã—: æœˆ(ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ/ãƒ©ãƒ³ã‚¸/ãƒ’ãƒƒãƒ—ãƒªãƒ•ãƒˆ), æ°´(ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—/ãƒ‘ã‚¤ã‚¯/ãƒ‡ã‚£ãƒƒãƒ—), é‡‘(ãƒ—ãƒ©ãƒ³ã‚¯/ã‚µã‚¤ãƒ‰ãƒ—ãƒ©ãƒ³ã‚¯/ãƒãƒ¼ãƒ‰ãƒ‰ãƒƒã‚°)ã€‚\n" +
                "å™¨å…·ã‚ã‚Š: æœˆ(ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹/ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«), æ°´(ãƒ©ãƒƒãƒˆãƒ—ãƒ«/ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹), é‡‘(ã‚±ãƒ¼ãƒ–ãƒ«ã‚¯ãƒ©ãƒ³ãƒ)ã€‚\n" +
                "é »åº¦: é€±3å›/å„15ã€œ20åˆ†/åˆè¨ˆ45ã€œ60åˆ†ã€‚æ „é¤Š: ä½“é‡Ã—1.5gã®ã‚¿ãƒ³ãƒ‘ã‚¯è³ª/æ—¥ã€ç¡çœ 7æ™‚é–“ä»¥ä¸Šã€‚"
            }
          },
          {
            id: 3,
            name: "30æ—¥ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆåœæ»ã—ãªã„ä¼¸ã°ã—æ–¹ï¼‰",
            content: {
              main: "1é€±ç›®: ãƒ•ã‚©ãƒ¼ãƒ å›ºã‚ â†’ 2é€±ç›®: åå¾©å¢— â†’ 3ã€œ4é€±ç›®: è² è·å¾®å¢—",
              details: "1é€±ç›®: å‹•ä½œã‚’æ’®å½±ã—ã¦ãƒã‚§ãƒƒã‚¯/é–¢ç¯€ç—›ã‚¼ãƒ­ã‚’å„ªå…ˆã€‚\n" +
                "2é€±ç›®: 10å›Ã—3ã‚»ãƒƒãƒˆãŒä½™è£•ãªã‚‰12å›ã¾ã§å¢—ã‚„ã™ã€‚\n" +
                "3ã€œ4é€±ç›®: å›æ•°ãŒä¼¸ã³ãŸç¨®ç›®ã ã‘1ã€œ2kgé‡ã/ãƒãƒ¥ãƒ¼ãƒ–ã‚’å›ºãã€‚\n" +
                "ç¥è©±ã¨äº‹å®Ÿ: ã€æ¯æ—¥ã‚„ã‚‹ã»ã©æ—©ãä¼¸ã³ã‚‹ã€â†’å›å¾©ãŒè¶³ã‚Šãšé€†åŠ¹æœã€‚ã€ç—›ã¿ã¯æˆé•·ã®ã‚µã‚¤ãƒ³ã€â†’æ€ªæˆ‘ã®ã‚µã‚¤ãƒ³ã€‚"
            }
          }
        ]
      };
    }

    // åˆ†é‡åˆ¥ã®ã‚ˆã‚Šå®Ÿç”¨çš„ãªãƒ¢ãƒƒã‚¯ï¼ˆç‰¹ã« lifestyleÃ—å­è‚²ã¦ ã‚’å¼·åŒ–ï¼‰
    if (category === 'lifestyle' && keyword.includes('å­è‚²ã¦')) {
      return {
        title: title,
        videoType: `${category}æƒ…å ±`,
        duration: duration,
        canvas: { width: spec.width, height: spec.height, backgroundColor: "#ffffff" },
        content: {
          description: `${keyword}ã‚’ä»Šæ—¥ã‹ã‚‰å®Ÿè·µã§ãã‚‹å½¢ã§è§£èª¬`,
          structure: "åŸºæœ¬â†’å…·ä½“â†’ã‚³ãƒ„ï¼ˆçŸ­æ™‚é–“ã§ç¶šã‘ã‚‰ã‚Œã‚‹ï¼‰"
        },
        items: [
          {
            id: 1,
            name: "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ·±ã‚ã‚‹",
            content: {
              main: "1æ—¥5åˆ†Ã—3å›ã®å¯¾è©±ãƒ»å…±æ„Ÿãƒ»ç¬‘é¡”ã®æ™‚é–“ã‚’ä½œã‚‹",
              details: "å…·ä½“ä¾‹: æœã®" +
                "ã€ä»Šæ—¥ã®æ¥½ã—ã¿ä½•ï¼Ÿã€ã€å¸°å®…å¾Œã®ã€ä»Šæ—¥ä¸€ç•ªå¬‰ã—ã‹ã£ãŸã“ã¨ã€ã€å¯ã‚‹å‰ã®èª­ã¿èã‹ã›1è©±ã€‚\n" +
                "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: ç›®ã‚’è¦‹ã‚‹/æœ€å¾Œã¾ã§èã/æ„Ÿæƒ…ã‚’è¨€è‘‰ã«ã™ã‚‹ï¼ˆã€ãã†ã ã£ãŸã‚“ã ã­ã€ï¼‰/å¦å®šã—ãªã„/1ã¤è¤’ã‚ã‚‹ã€‚\n" +
                "é »å‡ºãƒŸã‚¹: æŒ‡ç¤ºãŒå¤šã™ãã‚‹ã€å•ã„è©°ã‚ã‚‹ã€ã‚¹ãƒãƒ›ã‚’è¦‹ãªãŒã‚‰è©±ã™â†’å¯¾ç­–: ã¾ãšå…±æ„Ÿã€çŸ­ã„è³ªå•ã€çµè«–ã‚’æ€¥ãŒãªã„ã€‚\n" +
                "ä»Šæ—¥ã‹ã‚‰ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: é£Ÿå¾Œã«3åˆ†ã ã‘ã€ä»Šæ—¥ã®è‰¯ã‹ã£ãŸã“ã¨ã€ã‚’è¦ªå­ã§1ã¤ãšã¤å…±æœ‰ã™ã‚‹ã€‚"
            }
          },
          {
            id: 2,
            name: "å®‰å¿ƒã§ãã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’ä½œã‚‹",
            content: {
              main: "ã€èµ·ãã‚‹â†’é£Ÿã¹ã‚‹â†’éŠã¶â†’ç‰‡ä»˜ã‘â†’å¯ã‚‹ã€ã®ã‚·ãƒ³ãƒ—ãƒ«ãªæµã‚Œ",
              details: "æ™‚é–“å¸¯ã”ã¨ã«1ã¤ã ã‘æ±ºã‚ã‚‹ï¼ˆä¾‹: å¯ã‚‹å‰ã¯æœ¬ã‚’1å†Šï¼‰ã€‚\n" +
                "å…·ä½“ä¾‹: æœã¯ã€è‡ªåˆ†ã§æœã‚’é¸ã¶ã€ã€å¤•æ–¹ã¯ã€ãŠã‚‚ã¡ã‚ƒã‚¿ã‚¤ãƒãƒ¼5åˆ†ã§ç‰‡ä»˜ã‘ã€ã€‚\n" +
                "åŠ¹æœ: å…ˆèª­ã¿ã§ãã¦å®‰å¿ƒã€ç™‡ç™ªãŒæ¸›ã‚‹ã€è‡ªç«‹ãŒè‚²ã¤ã€‚"
            }
          },
          {
            id: 3,
            name: "è‡ªå·±è‚¯å®šæ„Ÿã‚’è‚²ã‚€",
            content: {
              main: "ã€ã§ããŸé‡ã€ã§ã¯ãªãã€å–ã‚Šçµ„ã¿æ–¹ã€ã‚’è¤’ã‚ã‚‹",
              details: "è¨€ã„æ›ãˆä¾‹: ã€æ—©ã„ã­ã€â†’ã€æœ€å¾Œã¾ã§ã‚„ã£ãŸã­ã€ã€è«¦ã‚ãšã«è©¦ã—ãŸã­ã€ã€‚\n" +
                "å®¶åº­ãƒ«ãƒ¼ãƒ«: å¤±æ•—ã‚’ç¬‘ã‚ãªã„ã€ç™ºè¡¨ã‚’é®ã‚‰ãªã„ã€åŠªåŠ›ã®é€”ä¸­ã‚’èªã‚ã‚‹ã€‚\n" +
                "é•·æœŸåŠ¹æœ: æ–°ã—ã„æŒ‘æˆ¦ã¸ã®æŠµæŠ—ãŒæ¸›ã‚Šã€è¦ªå­ã®ä¼šè©±é‡ãŒå¢—ãˆã‚‹ã€‚"
            }
          }
        ]
      };
    }

    // æ±ç”¨ç‰ˆï¼ˆãã®ä»–ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰
    return {
      title: title,
      videoType: `${category}æƒ…å ±`,
      duration: duration,
      canvas: { width: spec.width, height: spec.height, backgroundColor: "#ffffff" },
      content: {
        description: `${keyword}ã«ã¤ã„ã¦å®Ÿç”¨çš„ã§å½¹ç«‹ã¤æƒ…å ±`,
        structure: "åŸºæœ¬çŸ¥è­˜â†’å…·ä½“çš„æ–¹æ³•â†’å®Ÿè·µã®ã‚³ãƒ„"
      },
      items: [
        {
          id: 1,
          name: "åŸºæœ¬çš„ãªçŸ¥è­˜",
          content: {
            main: "åˆå¿ƒè€…ãŒçŸ¥ã£ã¦ãŠãã¹ãåŸºæœ¬ï¼ˆå…¨ä½“åƒâ†’çµè«–â†’ç†ç”±ï¼‰",
            details: "å…·ä½“ä¾‹3ã¤ãƒ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ»ã‚ˆãã‚ã‚‹ãƒŸã‚¹ã¨å¯¾ç­–ãƒ»ä»Šæ—¥ã‹ã‚‰1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
          }
        },
        {
          id: 2,
          name: "å…·ä½“çš„ãªæ–¹æ³•",
          content: {
            main: "å®Ÿéš›ã«å§‹ã‚ã‚‹å…·ä½“çš„ãªæ‰‹é †",
            details: "æ®µéšçš„ã«é€²ã‚ã‚‹ã“ã¨ã§ç¢ºå®Ÿã«ç¿’å¾—ã§ãã¾ã™"
          }
        },
        {
          id: 3,
          name: "ç¶™ç¶šã®ã‚³ãƒ„",
          content: {
            main: "é•·ãç¶šã‘ã‚‹ãŸã‚ã®ç§˜è¨£",
            details: "ç¿’æ…£åŒ–ã—ã¦ç¶™ç¶šã™ã‚‹ã“ã¨ãŒæˆåŠŸã®éµã§ã™"
          }
        }
      ]
    };
  }

  // ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚„ã™ã„æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ç°¡æ˜“ç‰ˆï¼‰
  generateClickableTitle(keyword, category) {
    const base = keyword.replace(/ã«ã¤ã„ã¦|ã¨ã¯/g, '').trim();
    const patterns = [
      `${base}ï½œä»Šæ—¥ã‹ã‚‰ã§ãã‚‹3ã¤ã®å®Ÿè·µ(ä¿å­˜ç‰ˆ)`,
      `${base}ã§å¤±æ•—ã—ãªã„ãŸã‚ã®3åŸå‰‡ï¼ˆèª°ã§ã‚‚ç°¡å˜ï¼‰`,
      `${base}ã®ã‚³ãƒ„3é¸ï¼»å…·ä½“ä¾‹ä»˜ãï¼½`,
      `${base}ã¯ã‚³ãƒ¬ã ã‘ï¼åˆå¿ƒè€…å‘ã‘3ã‚¹ãƒ†ãƒƒãƒ—`,
      `${base}ã§å¾Œæ‚”ã—ãªã„ãŸã‚ã«ï½œæœ€åˆã®3ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`
    ];
    if (category === 'lifestyle' && keyword.includes('å­è‚²ã¦')) {
      return `å­è‚²ã¦ãŒãƒ©ã‚¯ã«ãªã‚‹3ç¿’æ…£ï¼»ä¼šè©±ãƒ»ç”Ÿæ´»ãƒ»è‡ªä¿¡ï¼½`;
    }
    if (category === 'health' && /ç­‹ãƒˆãƒ¬|ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°|ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆ|åˆå¿ƒè€…/.test(keyword)) {
      return `ç­‹ãƒˆãƒ¬åˆå¿ƒè€…ã®æœ€çŸ­ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã€é€±3Ã—15åˆ†ã§å¤‰ã‚ã‚‹ã€‘`;
    }
    return patterns[base.length % patterns.length];
  }

  // å¾Œæ–¹äº’æ›æ€§
  async generateContent(keyword, template) {
    const videoDesign = await this.generateVideoDesign(keyword, template, 'short', 30);
    return {
      title: videoDesign.title,
      items: videoDesign.items,
      script: `${videoDesign.title}ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚`
    };
  }
}

const openaiService = new OpenAIService();
export default openaiService;