# いらすとやローカル画像システム

いらすとやの画像をローカルに一括取得して、高速な画像選択を実現するシステムです。

## 🚀 セットアップ手順

### 1. 依存関係のインストール

```bash
npm install
```

### 2. スクレイピングサーバーの起動

```bash
# スクレイピングサーバーのみ起動
npm run server

# または、フロントエンドと同時起動
npm run dev:full
```

### 3. 初回画像取得

```bash
# 全カテゴリの画像を一括取得
npm run scrape
```

## 📁 ディレクトリ構造

```
public/
├── images/
│   └── irasutoya/          # ローカル保存された画像
│       ├── metadata.json   # 画像メタデータ
│       ├── *.png          # 画像ファイル
│       └── *.jpg          # 画像ファイル
```

## 🔧 機能

### 自動スクレイピング
- **毎日午前3時**: 新着画像の自動取得
- **毎週日曜午前2時**: 全カテゴリの深いスクレイピング

### カテゴリ別取得
- 職業
- お金
- 健康・運動
- 勉強・学習
- 仕事・ビジネス
- 恋愛・家族
- 食べ物・動物
- 季節・行事

### API エンドポイント

#### 画像検索
```
GET /api/images/search?keyword=副業&limit=20
```

#### 全画像取得
```
GET /api/images/all?limit=100
```

#### スクレイピング実行
```
POST /api/scrape/all
POST /api/scrape/category/職業
```

#### メタデータ取得
```
GET /api/metadata
```

## 🎨 フロントエンド統合

### ImageSelectorコンポーネントの機能

1. **サーバー状態表示**: ローカル画像サーバーのオンライン/オフライン状態
2. **ローカル画像優先**: チェックボックスでローカル画像の優先使用を切り替え
3. **スクレイピング機能**: キーワード別・全カテゴリのスクレイピング実行
4. **フォールバック**: ローカル画像が少ない場合は従来のいらすとやサービスを使用

### 使用方法

```jsx
import ImageSelector from './components/ImageSelector';

// 画像選択ダイアログを表示
<ImageSelector 
  keyword="副業"
  onImageSelect={(image) => console.log('選択された画像:', image)}
  onClose={() => setShowImageSelector(false)}
/>
```

## ⚙️ 設定

### サーバー設定
- **ポート**: 3001 (環境変数 `PORT` で変更可能)
- **画像保存先**: `public/images/irasutoya/`
- **ユーザーエージェント**: Chrome 91相当

### スクレイピング設定
- **レート制限**: 画像間で2秒、カテゴリ間で3秒の待機
- **タイムアウト**: 10秒（ページ取得）、15秒（画像ダウンロード）
- **最大ページ数**: カテゴリごとに3ページ（設定可能）

## 🔍 トラブルシューティング

### よくある問題

1. **サーバーが起動しない**
   - ポート3001が使用中でないか確認
   - 依存関係が正しくインストールされているか確認

2. **画像が取得できない**
   - インターネット接続を確認
   - いらすとやサイトのアクセス制限を確認
   - ログでエラー詳細を確認

3. **フロントエンドで画像が表示されない**
   - サーバーが起動しているか確認
   - CORS設定を確認
   - 画像パスの設定を確認

### ログ確認

```bash
# サーバーログを確認
npm run server

# コンソールでリアルタイムログを確認
```

## 📊 パフォーマンス

### 期待される効果

- **検索速度**: ローカル検索により大幅な高速化
- **安定性**: 外部サイトへの依存を削減
- **可用性**: オフラインでも利用可能な画像ライブラリ

### メモリ使用量

- **画像キャッシュ**: 5分間のメモリキャッシュ
- **メタデータ**: JSON形式で軽量管理
- **ストレージ**: 画像ファイルはローカルに保存

## 🔄 メンテナンス

### 定期メンテナンス

1. **古い画像の削除**: 定期的なクリーンアップ
2. **メタデータの最適化**: 重複画像の除去
3. **新カテゴリの追加**: 必要に応じてカテゴリを拡張

### バックアップ

```bash
# 画像データのバックアップ
tar -czf irasutoya_backup.tar.gz public/images/irasutoya/
```

## 📝 注意事項

- いらすとやの利用規約を遵守してください
- 過度なスクレイピングは避けてください
- 取得した画像は個人利用に留めてください
- 商用利用の場合は適切なライセンスを確認してください

## 🤝 貢献

バグ報告や機能追加の提案は、GitHubのIssueでお知らせください。

---

**参考**: [いらすとやスクレイピング記事](https://qiita.com/japanesebonobo/items/eb374a94ed0456c88ed7)
